$(window).load(function(){function h(e){var t=null;if(document.cookie&&document.cookie!=""){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=jQuery.trim(n[r]);if(i.substring(0,e.length+1)==e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t}function p(e,t,n,r,i,s,u,a,f,l,c){var e=e;var t=t;var n=n;var r=r;var h=i;var p={p:u,b:s};var d="/public/img/device/"+r+".svg";var a=a;var f=f+o.x;var l=l+o.y;var v={x:55,y:50};var c=c;this.Draw=function(){a.image(d,f,l,100,100).scale(c.x,c.y).mouseover(function(){$("#d").html('<table><tr><td><label class="label">Hostname : </label></td><td>'+h+'</td></tr><tr><td><label class="label">IP : </label></td><td id="aip">'+e+'</td></tr><tr><td><label class="label">MAC : </label></td></td><td>'+t+'</td></tr><tr><td><label class="label">OS : </label></td></td><td><button id="dos" class="btn btn-inverse" type="button">Détection d\'OS</button></td></tr><tr><td><label class="label">Bande passante : </label></td></td><td> '+p.p+"% ("+p.b+" kb/s)</td</tr></table>")}).drag(function(){return false})};this.GetX=function(){return f+v.x};this.GetY=function(){return l+v.y};this.GetIp=function(){return e};this.GetBw=function(){return p};this.SetBw=function(e,t){p.percent=e;p.mega=t};this.SetMac=function(e){t=e}}function d(e){var i=60;var u={x:$("#main").width()/2-i,y:$("#main").height()/2-i};var f=500+e.net.length+500*.25;var l=u.x;var c=u.y;var h;var d=0;var v=360/e.net.length+.5;s=[];s[0]=new p(e.gw,"8c:89:a5:a3:ad:1f","Linux","router","Itinet",0,0,t,l/a.connector,c/a.connector,{x:.6+a.device,y:.6+a.device});var m={x:s[0].GetX(),y:s[0].GetY()};var g='<table class="table table-striped"><tr><td>Hostname</td><td>IP</td></tr>';for(var y=0;y<e.net.length;y++){if(s[0].GetIp()==e.net[y].ip){s[0].SetMac(e.net[y].mac);s[0].SetBw(e.net[y].percent,e.net[y].bw*8)}else{h=d/180*Math.PI;color=e.net[y].percent==null?"rgb(0, 0, 255)":e.net[y].percent<1?"rgb(0, 252, 0)":e.net[y].percent<2?"rgb(36, 216, 0)":e.net[y].percent<5?"rgb(72, 180, 0)":e.net[y].percent<10?"rgb(108, 144, 0)":e.net[y].percent<20?"rgb(144, 108, 0)":e.net[y].percent<50?"rgb(180, 72, 0)":e.net[y].percent<70?"rgb(216, 36, 0)":"rgb(252, 0, 0)";l=(f/2+f/2*Math.cos(h)+u.x-f+340)/a.connector;c=(f/2+f/2*Math.sin(h)+u.y-f+340)/a.connector;s[y+1]=new p(e.net[y].ip,e.net[y].mac,e.net[y].os,e.net[y].device,e.net[y].hostname,e.net[y].bw*8,e.net[y].percent,t,l,c,{x:.4+a.device,y:.4+a.device});s[y+1].Draw();n.path("M"+s[y+1].GetX()+" "+s[y+1].GetY()+"L"+m.x+" "+m.y).attr({stroke:color,"stroke-width":5});d+=v;g+="<tr data-x='"+(parseFloat(l)+o.x)+"' data-y='"+(parseFloat(c)+o.y)+'\'><td class="shostname">'+e.net[y].hostname+'</td><td class="sip">'+e.net[y].ip+"</td></tr>"}}s[0].Draw();g+="</table>";$("#search").html(g);$(".shostname, .sip").on("click",function(e){$("circle").remove();var t=Raphael.animation({"20%":{r:20,easing:"bounce"},"40%":{r:40,easing:"bounce"},"60%":{r:20,easing:"bounce"},"80%":{r:40,easing:"bounce"},"100%":{r:30,easing:"bounce"}},5e3);r.circle(parseFloat(e.target.parentNode.getAttribute("data-x"))+50,parseFloat(e.target.parentNode.getAttribute("data-y"))+50,30).attr({fill:"#FF0000"}).animate(t)})}function v(e,t){$.ajax({type:"post",headers:{"X-CSRFToken":i},data:e,url:"/screenshot/",timeout:2e4,success:function(e){t(JSON.parse(e));m(JSON.parse(e))},error:function(){alert("La requête n'a pas abouti")}})}function m(e){$("path").remove();$("image").remove();$("circle").remove();d(e)}var e;var t=Raphael(document.getElementById("svgDevice"),900,600);var n=Raphael(document.getElementById("svgBw"),900,600);var r=Raphael(document.getElementById("svgSearch"),900,600);var i=h("csrftoken");var s=[];var o={x:0,y:0};var u={x:0,y:0,ok:0};var a={device:0,connector:1};var f;var l=17;$("#pop").resizable({animate:true}).draggable().tabs();$("#form").resizable({animate:true}).draggable();var c=[];$("#dellmap").on("click",function(e){var t=$("#name").val();$.ajax({type:"post",headers:{"X-CSRFToken":i},data:{name:t},url:"/delete/",timeout:2e4,success:function(e){$("#inf").html('<div class="container alert alert-info"><button type="button" class="close" data-dismiss="alert">×</button>La carte '+t+" a bien été effacé.<br />La page va être rechargée dans 2 secondes</div>");window.setTimeout(function(){$("#inf").html('<div class="container alert alert-info"><button type="button" class="close" data-dismiss="alert">×</button>La page est sur le point de se rafraichir</div>');window.location.href="/visu/"},2e3)},error:function(){alert("La requête n'a pas abouti")}})});$("#form0").on("submit",function(e){e.preventDefault();v($(this).serialize(),function(e){function i(t){if(t>0){if(a.device>-.19&&a.connector>.49){a.device-=.1;a.connector-=.25;m(e)}}else{if(a.device<.3&&a.connector<1.525){a.device+=.1;a.connector+=.25;m(e)}}}f=e;var t=0;var n=0;for(var r=0;r<e.net.length;r++){if(e.net[r].bw!=null&&e.net[r].percent!=null){n+=e.net[r].bw*8;t+=e.net[r].percent;console.log("obj "+e.net[r].percent);console.log("val "+t)}}color=t<25?"green":t<50?"yellow":t<75?"orange":"red";$("#cbw").css({width:t*3.5,"background-color":color});$("#binfo").html("<span class='label'>Bande passante total utilisée : </span><ul><li class='offset1'>"+t.toFixed(2)+" %</li><li class='offset1'>"+n.toFixed(2)+" kb/s</li></ul>");$("svg").mousewheel(function(e,t,n,r){e.preventDefault();i(t);return false});$("svg").on("mousedown",function(e){e.preventDefault();u.x=e.clientX;u.y=e.clientY;return false});$("svg").on("mouseup",function(t){t.preventDefault();o.x-=(u.x-t.clientX)*.5;o.y-=(u.y-t.clientY)*.5;m(e);return false});$(document).on("keydown",function(t){c.push(t.keyCode);if(c.toString().indexOf("38,38,40,40,37,39,37,39,66,65")>=0){$("body").css({"background-image":"url('/public/img/konami.gif')"});$("#svgDevice").addClass("koko");$("#svgBw").addClass("koko2")}if(t.keyCode>36&&t.keyCode<41||t.keyCode==107||t.keyCode==109){t.preventDefault();t.keyCode==38?o.y-=l:t.keyCode==39?o.x-=l:t.keyCode==40?o.y+=l:t.keyCode==37?o.x+=l:t.keyCode==109?i(-1):t.keyCode==107?i(1):o.x+=0;m(e);return false}});$(".mapcontroll, #reset").on("click",function(t){if(/mapcontroll/.test(t.target.className)){t.target.id=="m0"?o.y-=l:t.target.id=="m1"?o.x+=l:t.target.id=="m2"?o.x-=l:t.target.id=="m3"?o.y+=l:t.target.id=="m4"?i(1):t.target.id=="m5"?i(-1):o.x+=0;if(t.target.id!="m4"||t.target.id!="m5")m(e)}else if(t.target.id=="reset"){o.x=0;o.y=0;a.device=0;a.connector=1;m(e)}})})})}())