$(window).load(function(){function l(e){var t=null;if(document.cookie&&document.cookie!=""){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=jQuery.trim(n[r]);if(i.substring(0,e.length+1)==e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t}function c(e,t,n){$(t).html(n);$(e).modal("show")}function h(t){t.preventDefault();$.ajax({type:"post",headers:{"X-CSRFToken":i},data:$(this).serialize(),url:"/ajaxform/"+e+"/",success:function(e){e=JSON.parse(e);var t=e.success==1?"success":"danger";$("#info").html('<div class="alert alert-'+t+'"><button type="button" class="close" data-dismiss="alert">×</button>'+e.why+"</div>")},error:function(){$("#info").html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">×</button>La requête n\'a pas pu aboutir</div>')}})}function p(e,t,n,r,s,u,a,l,c,h,p){var e=e;var t=t;var n=n;var r=r;var v=s;var m={p:a,b:u};var g="/public/img/device/"+r+".svg";var l=l;var c=c+f.GetGapX();var h=h+f.GetGapY();var y={x:55,y:50};var p=p;this.Draw=function(){l.image(g,c,h,100,100).scale(p.x,p.y).mouseover(function(){$("#d").html('<table><tr><td><label class="label">Hostname : </label></td><td>'+v+'</td></tr><tr><td><label class="label">IP : </label></td><td id="aip">'+e+'</td></tr><tr><td><label class="label">MAC : </label></td></td><td>'+t+'</td></tr><tr><td><label class="label">OS : </label></td></td><td><button id="dos" class="btn btn-inverse" type="button">Détection d\'OS</button></td></tr><tr><td><label class="label">Bande passante : </label></td></td><td> '+m.p+"% ("+m.b+" kb/s)</td</tr></table>");$("#dos").on("click",function(){if(o.os==0){o.os=1;$("#inf").html('<div class="container alert alert-info">L\'os finger printing est lancée. Cette action peut prendre un certain temps</div>');$("#os").html();$.ajax({type:"post",headers:{"X-CSRFToken":i},data:{ip:$("#aip").html()},url:"/os/",success:function(e){d=JSON.parse(e);$("#os").html(d.rep);o.os=0;if(d.success=1)$("#inf").html('<div class="container alert alert-info"><button type="button" class="close" data-dismiss="alert">×</button>La fonctionnalité d\'os finger printing est à nouveau disponible</div>');else $("#inf").html('<div class="container alert alert-warning"><button type="button" class="close" data-dismiss="alert">×</button>Un problème est survenu ... <br />Mais la fonctionnalité d\'os finger printing est à nouveau disponible</div>')},error:function(){alert("La requête n'a pas abouti");o.os=0}})}else{$("#inf").html('<div class="container alert alert-error"><button type="button" class="close" data-dismiss="alert">×</button>La fonctionnalité d\'os finger printing n\'est pas encore disponible</div>')}})}).drag(function(){return false})};this.GetX=function(){return c+y.x};this.GetY=function(){return h+y.y};this.GetIp=function(){return e};this.GetBw=function(){return m};this.GetHostname=function(){return v};this.SetBw=function(e,t){m.percent=e;m.mega=t};this.SetMac=function(e){t=e}}function v(e){var i=60;var o={x:$("#main").width()/2-i,y:$("#main").height()/2-i};var u=500+e.net.length+500*.25;var a=o.x;var l=o.y;var c;var h=0;var d=360/e.net.length+.5;s=[];s[0]=new p(e.gw,"8c:89:a5:a3:ad:1f","Linux","router","Itinet",0,0,t,a/f.GetScaleConnector(),l/f.GetScaleConnector(),{x:.6+f.GetScaleDevice(),y:.6+f.GetScaleDevice()});var v={x:s[0].GetX(),y:s[0].GetY()};var m='<table class="table table-striped"><tr><td>Hostname</td><td>IP</td></tr>';for(var g=0;g<e.net.length;g++){if(s[0].GetIp()==e.net[g].ip){s[0].SetMac(e.net[g].mac);s[0].SetBw(e.net[g].percent,e.net[g].bw*8)}else{c=h/180*Math.PI;color=e.net[g].percent==null?"rgb(0, 0, 255)":e.net[g].percent<1?"rgb(0, 252, 0)":e.net[g].percent<2?"rgb(36, 216, 0)":e.net[g].percent<5?"rgb(72, 180, 0)":e.net[g].percent<10?"rgb(108, 144, 0)":e.net[g].percent<20?"rgb(144, 108, 0)":e.net[g].percent<50?"rgb(180, 72, 0)":e.net[g].percent<70?"rgb(216, 36, 0)":"rgb(252, 0, 0)";a=(u/2+u/2*Math.cos(c)+o.x-u+340)/f.GetScaleConnector();l=(u/2+u/2*Math.sin(c)+o.y-u+340)/f.GetScaleConnector();s[g+1]=new p(e.net[g].ip,e.net[g].mac,e.net[g].os,e.net[g].device,e.net[g].hostname,e.net[g].bw*8,e.net[g].percent,t,a,l,{x:.4+f.GetScaleDevice(),y:.4+f.GetScaleDevice()});s[g+1].Draw();n.path("M"+s[g+1].GetX()+" "+s[g+1].GetY()+"L"+v.x+" "+v.y).attr({stroke:color,"stroke-width":5});h+=d;m+="<tr data-x='"+(parseFloat(a)+f.GetGapX())+"' data-y='"+(parseFloat(l)+f.GetGapY())+'\'><td class="shostname">'+e.net[g].hostname+'</td><td class="sip">'+e.net[g].ip+"</td></tr>"}}s[0].Draw();m+="</table>";$("#search").html(m);$(".shostname, .sip").on("click",function(e){$("circle").remove();var t=Raphael.animation({"20%":{r:20,easing:"bounce"},"40%":{r:40,easing:"bounce"},"60%":{r:20,easing:"bounce"},"80%":{r:40,easing:"bounce"},"100%":{r:30,easing:"bounce"}},5e3);r.circle(parseFloat(e.target.parentNode.getAttribute("data-x"))+50,parseFloat(e.target.parentNode.getAttribute("data-y"))+50,30).attr({fill:"#FF0000"}).animate(t)})}function m(e){$.ajax({type:"post",headers:{"X-CSRFToken":i},url:"/getjson/",success:function(t){y(JSON.parse(t));e(JSON.parse(t))},error:function(){alert("La requête n'a pas abouti")}})}function g(e){if(e>0){if(f.GetScaleDevice()>-.19&&f.GetScaleConnector()>.49){f.SetScaleDevice(0);f.SetScaleConnector(0);y(u)}}else{if(f.GetScaleDevice()<.3&&f.GetScaleConnector()<1.525){f.SetScaleDevice(1);f.SetScaleConnector(1);y(u)}}}function y(e){$("circle").remove();$("path").remove();$("image").remove();v(e)}function b(){var e={x:0,y:0};var t={x:0,y:0};var n={device:0,connector:1};var r=17;var i=.1;var s=.25;this.Init=function(){};this.Reset=function(){e.x=0;e.y=0;n.device=0;n.connector=1};this.GetGapX=function(){return e.x};this.GetGapY=function(){return e.y};this.SetGapX=function(t){t==0?e.x-=r:e.x+=r};this.SetGapY=function(t){t==0?e.y-=r:e.y+=r};this.UpdateGap=function(t){e.x+=t.x;e.y+=t.y};this.GetMouseX=function(){return t.x};this.GetMouseY=function(){return t.y};this.SetMouseX=function(e){t.x=e};this.SetMouseY=function(e){t.y=e};this.GetMove=function(){return r};this.SetMove=function(e){r=e};this.GetScaleDevice=function(){return n.device};this.GetScaleConnector=function(){return n.connector};this.SetScaleDevice=function(e){e==0?n.device-=i:n.device+=i};this.SetScaleConnector=function(e){e==0?n.connector-=s:n.connector+=s}}var e;var t=Raphael(document.getElementById("svgDevice"),900,600);var n=Raphael(document.getElementById("svgBw"),900,600);var r=Raphael(document.getElementById("svgSearch"),900,600);var i=l("csrftoken");var s=[];var o={os:0,sniff:0};$("#pop").resizable({animate:true}).draggable().tabs();var u;var a=[];var f=new b;$("a.menu").on("click",function(){e=this.id;$.ajax({type:"post",headers:{"X-CSRFToken":i},data:{id:this.id},url:"/control/",success:function(t){if(e>=0&&e<=1||e>=3&&e<=6){c("#option","#dispopt",t);if(e==1){$("#form0").on("submit",function(t){t.preventDefault();$.ajax({type:"post",headers:{"X-CSRFToken":i},data:{name:$(this).serialize().split("=")[1],net:JSON.stringify(u)},url:"/ajaxform/"+e+"/",success:function(e){e=JSON.parse(e);var t=e.success==1?"success":"danger";$("#info").html('<div class="alert alert-'+t+'"><button type="button" class="close" data-dismiss="alert">×</button>'+e.why+"</div>")},error:function(){$("#info").html('<div class="alert alert-warning"><button type="button" class="close" data-dismiss="alert">×</button>La requête n\'a pas pu aboutir</div>')}})})}else if(e!=6){$("#form0").on("submit",h);if(e==0){$("#form1").on("submit",h)}}}else if(e==2){window.open("/visu/")}},error:function(){alert("La requête n'a pas abouti")}})});$("#fsniff").on("submit",function(e){e.preventDefault();if(o.sniff==0){$("#rsniff").html("");$("#inf").html('<div class="container alert alert-info">L\'écoute est lancée pendant '+$("#stime").val()+" secondes</div>");o.sniff=1;$.ajax({type:"post",headers:{"X-CSRFToken":i},data:{ip:$("#aip").html(),name:$("#sname").val(),time:$("#stime").val()},url:"/sniff/",success:function(e){o.sniff=0;d=JSON.parse(e);if(d.success==1){$("#rsniff").html(d.rep);$("#inf").html('<div class="container alert alert-info"><button type="button" class="close" data-dismiss="alert">×</button>La fonctionnalité d\'écoute est à nouveau disponible</div>')}else $("#inf").html('<div class="container alert alert-warning"><button type="button" class="close" data-dismiss="alert">×</button>Une erreur est survenu ... <br /> Mais la fonctionnalité d\'écoute est à nouveau disponible<br />'+e.rep+"</div>")},error:function(){alert("La requête n'a pas abouti");o.sniff=0}})}else{$("#inf").html('<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">×</button>La fonctionnalité d\'écoute n\'est pas encore disponible</div>')}return false});$("svg").mousewheel(function(e,t,n,r){e.preventDefault();g(t);return false});$("svg").on("mousedown",function(e){e.preventDefault();f.SetMouseX(e.clientX);f.SetMouseY(e.clientY);return false});$("svg").on("mouseup",function(e){e.preventDefault();f.UpdateGap({x:f.GetMouseX()-e.clientX,y:f.GetMouseY()-e.clientY});y(u);return false});$(window).on("keydown",function(e){a.push(e.keyCode);if(a.toString().indexOf("38,38,40,40,37,39,37,39,66,65")>=0){$("body").css({"background-image":"url('/public/img/konami.gif')"});$("#svgDevice").addClass("koko");$("#svgBw").addClass("koko2")}if(e.keyCode>36&&e.keyCode<41||e.keyCode==107||e.keyCode==109){e.preventDefault();e.keyCode==38?f.SetGapY(0):e.keyCode==39?f.SetGapX(0):e.keyCode==40?f.SetGapY(1):e.keyCode==37?f.SetGapX(1):e.keyCode==109?g(-1):e.keyCode==107?g(1):{};y(u);return false}});$(".mapcontroll, #reset").on("click",function(e){if(/mapcontroll/.test(e.target.className)){e.target.id=="m0"?f.SetGapY(1):e.target.id=="m1"?f.SetGapX(1):e.target.id=="m2"?f.SetGapX(0):e.target.id=="m3"?f.SetGapY(0):e.target.id=="m4"?g(1):e.target.id=="m5"?g(-1):{};if(e.target.id!="m4"||e.target.id!="m5")y(u)}else if(e.target.id=="reset"){f.Reset();y(u)}});window.setInterval(pwned=function(){m(function(e){u=e;var t=0;var n=0;for(var r=0;r<e.net.length;r++){if(e.net[r].bw!=null&&e.net[r].percent!=null){n+=e.net[r].bw*8;t+=e.net[r].percent}}color=t<25?"green":t<50?"yellow":t<75?"orange":"red";$("#cbw").css({width:t*3.5,"background-color":color});$("#binfo").html("<span class='label'>Bande passante totale utilisée : </span><ul><li class='offset1'>"+t.toFixed(2)+" %</li><li class='offset1'>"+n.toFixed(2)+" kb/s</li></ul>")})},3e4);pwned()}())